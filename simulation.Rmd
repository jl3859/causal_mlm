---
title: "simulation"
date: "12/13/2019"
output: pdf_document
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy = TRUE)
library(tidyverse)
library(lfe)
library(lme4)
library(lmerTest)
library(plm)
library(gridExtra)
inv.logit <- function(X) exp(X)/(1 + exp(X))
iter <- 100
```

Section I: Base Scenario for Comparison (Meets Assumptions)

```{r}
class_dat_function <- function(classrooms, students){
  # classroom level covariates
  yearstea <- abs(rep(round(rnorm(classrooms, 5, 5),0), each = students)) # trying to get a range between 0-20
  teach.edu <- rep(sample(c(rep(1,classrooms*.725), rep(2,classrooms*.25), rep(3,classrooms*.025))), each = students) # 
  avgtest <- rep(round(rnorm(classrooms, 72, 8),2), each = students) + 0.75*yearstea #correlated with teachers
  classroom_score <- rep(rnorm(classrooms, 0, 3), each = students) 
  
  # student level covariates
  N <- classrooms*students #number of total students
  
  minority <- sample(c(0:1), N, replace = T, prob = c(0.65, 0.35)) # 65% white students, 35% minority students
  parent.edu <- ifelse(minority == 1, sample(c(0,1,2,3,4), N, replace = T, prob = c(.40, .30, .24, .05, .01)),
                     sample(c(0,1,2,3,4), N, replace = T, prob =c(.17, .26, .40, .10, .07))) # conditional if the student is a minority
  fam.income <- abs(round(abs(rnorm(N, 50, 20)) + ifelse(parent.edu > 2, 15*parent.edu, 0) + ifelse(parent.edu == 2, 6*parent.edu, 0) + 
                            ifelse(minority == 1, rnorm(N, -7, 1), 0),3)) #correlated with parent education and minority 
  freelunch <- ifelse(fam.income < 46.635, 1, 0) # free lunch if family income is less than ~46.6K 
  dist.school.hour <- round(abs(rnorm(N, 20, 4)),0)/60 # indepdent 
  gender <- sample(c(0:1), N, replace = T, prob = c(0.50, 0.50)) # independent
  pretest <-  61 + 0.4*yearstea + 0.3*teach.edu + 0.71*parent.edu + 0.15*fam.income - 2*minority - 1.5*dist.school.hour + rnorm(N, 1, 7)
  
  # random probability of assignment at student-level and classroom-level 
  X_stud <- rnorm(N, 0, 1)
  prob_stud <- inv.logit((X_stud/max(abs(X_stud))) * log(19))
  Z_stud <- rbinom(N, 1, prob = prob_stud)
  
  
  X_class <- rnorm(classrooms, 0, 1) + 0.1*as.numeric(names(table(avgtest)))
  prob_class <- inv.logit((X_class/max(abs(X_class)))*log(19))
  Z_class <- rbinom(classrooms, 1, prob = prob_class)
  Z_class <- rep(Z_class, each = students)
  
  # outcomes 
  Y0 = 56 + 0 + 0.4*yearstea + 0.33*teach.edu + 0.74*parent.edu + 0.18*fam.income - 2.23*minority - 1.4*dist.school.hour + classroom_score +  rnorm(N, 0 ,1)
  Y1 = 56 + 5 + 0.4*yearstea + 0.33*teach.edu + 0.74*parent.edu + 0.18*fam.income - 2.23*minority - 1.4*dist.school.hour + classroom_score +  rnorm(N, 0 ,1)
  
  # observed outcome based on treatment 
  Y_stud <- ifelse(Z_stud == 1, Y1, Y0)
  Y_class <- ifelse(Z_class == 1, Y1, Y0)
  # create dataset
  classroom_dat <- data.frame(yearstea = yearstea, teach.edu = as.factor(teach.edu), avgtest = avgtest,  
                            minority = as.factor(minority), parent.edu = as.factor(parent.edu), fam.income = fam.income,  
                            freelunch = as.factor(freelunch), dist.school.hour = dist.school.hour, gender = as.factor(gender), pretest = pretest,
                            classid = rep(1:classrooms, each = students), studentid  = 1:N, 
                            Z_stud = Z_stud, Z_class = Z_class, Y0 = Y0, Y1 = Y1, Y_stud = Y_stud, Y_class = Y_class)
  
  return(classroom_dat)
}
```

```{r}
set.seed(2020)
classroom_dat <- class_dat_function(40, 25)
```

```{r}
par(mfrow = c(2,3))
plot(classroom_dat$yearstea, classroom_dat$avgtest, xlab = "Years teaching", ylab="Average Test Scores", main = "")
hist(classroom_dat$fam.income, main = "Family Income")
hist(classroom_dat$pretest, main = "Pretest Scores")
plot(classroom_dat$parent.edu, classroom_dat$fam.income, xlab= "Parent Education", ylab = "Family Income")
plot(classroom_dat$pretest, classroom_dat$Y_stud, xlab = "9th grades scores", ylab = "10th grade scores", main = "Randomized at student-level")
plot(classroom_dat$pretest, classroom_dat$Y_class, xlab = "9th grades scores", ylab = "10th grade scores", main = "Randomized at classroom-level") 
```

```{r}
plot(x=factor(classroom_dat$classid), y=classroom_dat$Y_stud, xlab= "Classid", ylab = "10th grade test scores", ylim = c(50, 100))
plot(x=factor(classroom_dat$classid), y=classroom_dat$Y_class, xlab= "Classid", ylab = "10th grade test scores", 
     ylim = c(50,100))
```


```{r}
SATE <- mean(classroom_dat$Y1) - mean(classroom_dat$Y0)
model_stu <- classroom_dat %>% select(Y_stud, Z_stud, yearstea, teach.edu, avgtest, minority, parent.edu, 
                                      fam.income, freelunch, dist.school.hour, gender, pretest, classid)

#Base Linear Regression
lr.base <- lm(Y_stud ~., data = model_stu[,-13])
summary(lr.base)

#Base - Linear Regression Model Bias
(lr.base.bias <- lr.base$coefficients[2] - SATE)

#Base w/ Fixed Effects
fixed.base <- lfe::felm(model_stu$Y_stud ~ model_stu$Z_stud + model_stu$minority + model_stu$parent.edu +
                          model_stu$fam.income + model_stu$freelunch + model_stu$dist.school.hour + model_stu$gender +
                          model_stu$pretest | model_stu$classid) 
summary(fixed.base)

fixed.base.factor <- lm(model_stu$Y_stud ~ model_stu$Z_stud + model_stu$minority + model_stu$parent.edu +
                          model_stu$fam.income + model_stu$freelunch + model_stu$dist.school.hour + model_stu$gender +
                          model_stu$pretest + factor(model_stu$classid))
summary(fixed.base.factor)$coefficients[2]

#Base - Fixed Effects Model Bias
(fe.base.bias <- fixed.base$coefficients[1] - SATE)

#Base w/ Random Effects
random.base <- lmerTest::lmer(Y_stud ~ Z_stud + minority + parent.edu + fam.income + freelunch + dist.school.hour +
                                gender + pretest + (1 | classid), data = model_stu)
summary(random.base)

#Base - Random Effects Model Bias
(re.base.bias <- summary(random.base)$coefficients[2,1] - SATE)

```

```{r, message=FALSE}
# Randomization Distribution - Base Case

base_rd_sim <- data.frame(type = rep(NA, iter*3), coef = rep(NA, iter*3), conf_int_low = rep(NA, iter*3), conf_int_high = rep(NA, iter*3))
count <- 1

for(i in 1:iter){
  
  #Randomization Distribution - randomize treatment
  base_data <- classroom_dat
  N <- nrow(base_data)
  
  X_stud <- rnorm(N, 0, 1)
  prob_stud <- inv.logit((X_stud/max(abs(X_stud))) * log(19))
  Z_stud <- rbinom(N, 1, prob = prob_stud)
  
  base_data$Z_stud <- Z_stud
  base_data$Y_stud <- ifelse(Z_stud == 1, base_data$Y1, base_data$Y0)
  
  base_data_model <- base_data %>% select(Y_stud, Z_stud, yearstea, teach.edu, avgtest, minority, parent.edu, 
                                          fam.income, freelunch, dist.school.hour, gender, pretest, classid)

  #Linear Regression Sim
  j <- count
  base_rd_sim[j,1] <- "lr"
  lr_base_sim <- lm(Y_stud ~., data = base_data_model[,-13])
  base_rd_sim[j,2] <- lr_base_sim$coefficients[2]
  base_rd_sim[j,3] <- confint(lr_base_sim, 'Z_stud', level = .95)[1,1]
  base_rd_sim[j,4] <- confint(lr_base_sim, 'Z_stud', level = .95)[1,2]
  
  #Fixed Effect Sim
  j <- count+1
  base_rd_sim[j,1] <- "fixed"
  fixed_base_sim <- lfe::felm(base_data_model$Y_stud ~ base_data_model$Z_stud + base_data_model$minority +
                            base_data_model$parent.edu + base_data_model$fam.income + base_data_model$freelunch +
                            base_data_model$dist.school.hour + base_data_model$gender + base_data_model$pretest |
                            base_data_model$classid) 
  base_rd_sim[j,2] <- fixed_base_sim$coefficients[1]
  base_rd_sim[j,3] <- confint(fixed_base_sim, 'base_data_model$Z_stud', level = .95)[1,1]
  base_rd_sim[j,4] <- confint(fixed_base_sim, 'base_data_model$Z_stud', level = .95)[1,2]
  
  #Random Effect Sim
  j <- count+2
  base_rd_sim[j,1] <- "random"
  random_base_sim <- lmerTest::lmer(Y_stud ~ Z_stud + minority + parent.edu + fam.income + freelunch + dist.school.hour +
                                gender + pretest + (1 | classid), data = base_data_model) 
  base_rd_sim[j,2] <- summary(random_base_sim)$coefficients[2,1]
  base_rd_sim[j,3] <- confint(random_base_sim, 'Z_stud', level = .95)[1,1]
  base_rd_sim[j,4] <- confint(random_base_sim, 'Z_stud', level = .95)[1,2]  
  
  count <- j+1
  print(i)
}

base_rd_sim$SATE <- rep(SATE, nrow(base_rd_sim))

```

```{r}

hist(base_rd_sim$coef[base_rd_sim$type == "lr"], main = "Randomization Distribution - Base (Linear Regression)", xlab = "Treatment Effect", xlim = c(min(base_rd_sim$coef)-.5, max = max(base_rd_sim$coef)+.5))
abline(v = SATE, col = "red")

hist(base_rd_sim$coef[base_rd_sim$type == "fixed"], main = "Randomization Distribution - Base (Fixed Effects)", xlab = "Treatment Effect", xlim = c(min(base_rd_sim$coef)-.5, max = max(base_rd_sim$coef)+.5))
abline(v = SATE, col = "red")

hist(base_rd_sim$coef[base_rd_sim$type == "random"], main = "Randomization Distribution - Base (Random Effects)", xlab = "Treatment Effect", xlim = c(min(base_rd_sim$coef)-.5, max = max(base_rd_sim$coef)+.5))
abline(v = SATE, col = "red")

```

```{r, message=FALSE}
# Sampling Distribution - Base Case

base_sd_sim <- data.frame(type = rep(NA, iter*3), coef = rep(NA, iter*3), conf_int_low = rep(NA, iter*3), conf_int_high = rep(NA, iter*3), SATE = rep(NA, iter*3))
count <- 1

for(i in 1:iter){
  
  #Sampling Distribution - resample data
  base_data <- class_dat_function(40, 25)
  SATE_sim <- mean(base_data$Y1) - mean(base_data$Y0)
  base_data_model <- base_data %>% select(Y_stud, Z_stud, yearstea, teach.edu, avgtest, minority, parent.edu, 
                                          fam.income, freelunch, dist.school.hour, gender, pretest, classid)

  #Linear Regression Sim
  j <- count
  base_sd_sim[j,1] <- "lr"
  lr_base_sim <- lm(Y_stud ~., data = base_data_model[,-13])
  base_sd_sim[j,2] <- lr_base_sim$coefficients[2]
  base_sd_sim[j,3] <- confint(lr_base_sim, 'Z_stud', level = .95)[1,1]
  base_sd_sim[j,4] <- confint(lr_base_sim, 'Z_stud', level = .95)[1,2]
  base_sd_sim[j,5] <- SATE_sim

  #Fixed Effect Sim
  j <- count+1
  base_sd_sim[j,1] <- "fixed"
  fixed_base_sim <- lfe::felm(base_data_model$Y_stud ~ base_data_model$Z_stud + base_data_model$minority +
                            base_data_model$parent.edu + base_data_model$fam.income + base_data_model$freelunch +
                            base_data_model$dist.school.hour + base_data_model$gender + base_data_model$pretest |
                            base_data_model$classid) 
  base_sd_sim[j,2] <- fixed_base_sim$coefficients[1]
  base_sd_sim[j,3] <- confint(fixed_base_sim, 'base_data_model$Z_stud', level = .95)[1,1]
  base_sd_sim[j,4] <- confint(fixed_base_sim, 'base_data_model$Z_stud', level = .95)[1,2]
  base_sd_sim[j,5] <- SATE_sim

  #Random Effect Sim
  j <- count+2
  base_sd_sim[j,1] <- "random"
  random_base_sim <- lmerTest::lmer(Y_stud ~ Z_stud + minority + parent.edu + fam.income + freelunch + dist.school.hour +
                                gender + pretest + (1 | classid), data = base_data_model) 
  base_sd_sim[j,2] <- summary(random_base_sim)$coefficients[2,1]
  base_sd_sim[j,3] <- confint(random_base_sim, 'Z_stud', level = .95)[1,1]
  base_sd_sim[j,4] <- confint(random_base_sim, 'Z_stud', level = .95)[1,2]  
  base_sd_sim[j,5] <- SATE_sim

  count <- j+1
  print(i)
}

```

```{r}

hist(base_sd_sim$coef[base_sd_sim$type == "lr"], main = "Sampling Distribution - Base (Linear Regression)", xlab = "Treatment Effect", xlim = c(min(base_sd_sim$coef)-.5, max = max(base_sd_sim$coef)+.5))
abline(v = mean(base_sd_sim$SATE), col = "red")

hist(base_sd_sim$coef[base_sd_sim$type == "fixed"], main = "Sampling Distribution - Base (Fixed Effects)", xlab = "Treatment Effect", xlim = c(min(base_sd_sim$coef)-.5, max = max(base_sd_sim$coef)+.5))
abline(v = mean(base_sd_sim$SATE), col = "red")

hist(base_sd_sim$coef[base_sd_sim$type == "random"], main = "Sampling Distribution - Base (Random Effects)", xlab = "Treatment Effect", xlim = c(min(base_sd_sim$coef)-.5, max = max(base_sd_sim$coef)+.5))
abline(v = mean(base_sd_sim$SATE), col = "red")

ggplot() +
  geom_histogram(data = base_sd_sim[base_sd_sim$type == "lr",], aes(x = coef), color = "blue", fill = "white", alpha = .25) +
  geom_histogram(data = base_sd_sim[base_sd_sim$type == "fixed",], aes(x = coef), color = "green", fill = "white", alpha = .25) +
  geom_histogram(data = base_sd_sim[base_sd_sim$type == "random",], aes(x = coef), color = "red", fill = "white", alpha = .25) +
  labs(x = "Treatment Effect", y = "Frequency") +
  geom_vline(xintercept=SATE, color = "black", linetype = "dashed", size = 1.25)

```



Section II: Violate Random Effects Assumption

```{r}
# Violate Random Effects Assumption
# Correlates the classroom_score adjustment with mean classroom pretest scores

re_dat_function <- function(classrooms, students){
  # classroom level covariates
  yearstea <- abs(rep(round(rnorm(classrooms, 5, 5),0), each = students)) # trying to get a range between 0-20
  teach.edu <- rep(sample(c(rep(1,classrooms*.725), rep(2,classrooms*.25), rep(3,classrooms*.025))), each = students) # 
  avgtest <- rep(round(rnorm(classrooms, 72, 8),2), each = students) + 0.75*yearstea #correlated with teachers
   
  # student level covariates
  N <- classrooms*students #number of total students
  
  minority <- sample(c(0:1), N, replace = T, prob = c(0.65, 0.35)) # 65% white students, 35% minority students
  parent.edu <- ifelse(minority == 1, sample(c(0,1,2,3,4), N, replace = T, prob = c(.40, .30, .24, .05, .01)),
                     sample(c(0,1,2,3,4), N, replace = T, prob =c(.17, .26, .40, .10, .07))) # conditional if the student is a minority
  fam.income <- abs(round(abs(rnorm(N, 50, 20)) + ifelse(parent.edu > 2, 15*parent.edu, 0) + ifelse(parent.edu == 2, 6*parent.edu, 0) + 
                            ifelse(minority == 1, rnorm(N, -7, 1), 0),3)) #correlated with parent education and minority 
  freelunch <- ifelse(fam.income < 46.635, 1, 0) # free lunch if family income is less than ~46.6K 
  dist.school.hour <- round(abs(rnorm(N, 20, 4)),0)/60 # indepdent 
  gender <- sample(c(0:1), N, replace = T, prob = c(0.50, 0.50)) # independent
  pretest <-  61 + 0.4*yearstea + 0.3*teach.edu + 0.71*parent.edu + 0.15*fam.income - 2*minority - 1.5*dist.school.hour + rnorm(N, 1, 7)
  
  # random probability of assignment at student-level and classroom-level 
  X_stud <- rnorm(N, 0, 1)
  prob_stud <- inv.logit((X_stud/max(abs(X_stud))) * log(19))
  Z_stud <- rbinom(N, 1, prob = prob_stud)
  
  X_class <- rnorm(classrooms, 0, 1)
  prob_class <- inv.logit((X_class/max(abs(X_class)))*log(19))
  Z_class <- rbinom(classrooms, 1, prob = prob_class)
  Z_class <- rep(Z_class, each = students)
  
  # violate random effects assumption by correlating classroom_score with pretest
  classroom_pretest <- data.frame(classid = rep(1:classrooms, each = students),pretest = pretest)
  classroom_pretest <- classroom_pretest %>% group_by(classid) %>% summarize(pretest_mean = mean(pretest))
  classroom_score <- rep(rnorm(classrooms, 0, 3), each = students) + .05*classroom_pretest$pretest_mean
  
  # outcomes 
  Y0 = 56 + 0 + 0.4*yearstea + 0.33*teach.edu + 0.74*parent.edu + 0.18*fam.income - 2.23*minority - 1.4*dist.school.hour + classroom_score +  rnorm(N, 0 ,1)
  Y1 = 56 + 5 + 0.4*yearstea + 0.33*teach.edu + 0.74*parent.edu + 0.18*fam.income - 2.23*minority - 1.4*dist.school.hour + classroom_score +  rnorm(N, 0 ,1)
  
  # observed outcome based on treatment 
  Y_stud <- ifelse(Z_stud == 1, Y1, Y0)
  Y_class <- ifelse(Z_class == 1, Y1, Y0)
  # create dataset
  classroom_dat <- data.frame(yearstea = yearstea, teach.edu = as.factor(teach.edu), avgtest = avgtest,  
                            minority = as.factor(minority), parent.edu = as.factor(parent.edu), fam.income = fam.income,  
                            freelunch = as.factor(freelunch), dist.school.hour = dist.school.hour, gender = as.factor(gender), pretest = pretest,
                            classid = rep(1:classrooms, each = students), studentid  = 1:N, 
                            Z_stud = Z_stud, Z_class = Z_class, Y0 = Y0, Y1 = Y1, Y_stud = Y_stud, Y_class = Y_class)
  
  return(classroom_dat) 
}
```


```{r}
re_dat <- re_dat_function(40, 25)

SATE_re <- mean(re_dat$Y1) - mean(re_dat$Y0)

model_stu_re <- re_dat %>% select(Y_stud, Z_stud, yearstea, teach.edu, avgtest, minority, parent.edu, 
                                  fam.income, freelunch, dist.school.hour, gender, pretest, classid)

#Random Effects Violation Linear Regression
lr.re <- lm(Y_stud ~., data = model_stu_re[,-13])
summary(lr.re)

#Random Effects Violation - Linear Regression Model Bias
(lr.re.bias <- lr.re$coefficients[2] - SATE_re)

#Random Effects Violation w/ Fixed Effects
fixed.re <- lfe::felm(model_stu_re$Y_stud ~ model_stu_re$Z_stud + model_stu_re$minority + model_stu_re$parent.edu +
                        model_stu_re$fam.income + model_stu_re$freelunch + model_stu_re$dist.school.hour +
                        model_stu_re$gender + model_stu_re$pretest | model_stu_re$classid) 
summary(fixed.re)$coefficients[1]

fixed.re.factor <- lm(model_stu_re$Y_stud ~ model_stu_re$Z_stud + model_stu_re$minority + model_stu_re$parent.edu +
                        model_stu_re$fam.income + model_stu_re$freelunch + model_stu_re$dist.school.hour +
                        model_stu_re$gender + model_stu_re$pretest + factor(model_stu_re$classid))
summary(fixed.re.factor)$coefficients[2]

#Random Effects Violation - Fixed Effects Model Bias
(fe.re.bias <- fixed.re$coefficients[1] - SATE_re)

#Random Effects Violation w/ Random Effects
random.re <- lmerTest::lmer(Y_stud ~ Z_stud + minority + parent.edu + fam.income + freelunch + dist.school.hour +
                              gender + pretest + (1 | classid), data = model_stu_re)
summary(random.re)

#Random Effects Violation - Random Effects Model Bias
(re.re.bias <- summary(random.re)$coefficients[2,1] - SATE_re)

```

Section III: Violate Ignorability Assumption 

```{r}

# Alter function to violate ignorability
# 1) Treatment assignment probability is based on pretest scores
# 2) Output data frame does not include distance to school in hours, which violates assumption of ignorability as this confounder affects both treatment assignment and outcome

ig_dat_function <- function(classrooms, students){
  # classroom level covariates
  yearstea <- abs(rep(round(rnorm(classrooms, 5, 5),0), each = students)) # trying to get a range between 0-20
  teach.edu <- rep(sample(c(rep(1,classrooms*.725), rep(2,classrooms*.25), rep(3,classrooms*.025))), each = students) # 
  avgtest <- rep(round(rnorm(classrooms, 72, 8),2), each = students) + 0.75*yearstea #correlated with teachers
  classroom_score <- rep(rnorm(classrooms, 0, 3), each = students) 
  
  # student level covariates
  N <- classrooms*students #number of total students
  
  minority <- sample(c(0:1), N, replace = T, prob = c(0.65, 0.35)) # 65% white students, 35% minority students
  parent.edu <- ifelse(minority == 1, sample(c(0,1,2,3,4), N, replace = T, prob = c(.40, .30, .24, .05, .01)),
                     sample(c(0,1,2,3,4), N, replace = T, prob =c(.17, .26, .40, .10, .07))) # conditional if the student is a minority
  fam.income <- abs(round(abs(rnorm(N, 50, 20)) + ifelse(parent.edu > 2, 15*parent.edu, 0) + ifelse(parent.edu == 2, 6*parent.edu, 0) + 
                            ifelse(minority == 1, rnorm(N, -7, 1), 0),3)) #correlated with parent education and minority 
  freelunch <- ifelse(fam.income < 46.635, 1, 0) # free lunch if family income is less than ~46.6K 
  dist.school.hour <- round(abs(rnorm(N, 20, 4)),0)/60 # indepdent 
  gender <- sample(c(0:1), N, replace = T, prob = c(0.50, 0.50)) # independent
  pretest <-  61 + 0.4*yearstea + 0.3*teach.edu + 0.71*parent.edu + 0.15*fam.income - 2*minority - 1.5*dist.school.hour + rnorm(N, 1, 7)
  
  # probability of assignment is based on pretest scores 
  low_count <- sum(pretest <= 65)
  high_count <- length(pretest) - low_count
  low_score <- sample(c(rep(0,round(.3*low_count,0)),rep(1,round(.7*low_count,0))), low_count)
  high_score <- sample(c(rep(0,round(.5*high_count,0)), rep(1, round(.5*high_count,0))), high_count)
  Z_stud <- rep(NA,N)
  Z_stud[pretest > 65] <- high_score
  Z_stud[pretest <= 65] <- low_score

  # outcomes 
  Y0 = 56 + 0 + 0.4*yearstea + 0.33*teach.edu + 0.74*parent.edu + 0.18*fam.income - 2.23*minority - 1.4*dist.school.hour + classroom_score +  rnorm(N, 0 ,1)
  Y1 = 56 + 5 + 0.4*yearstea + 0.33*teach.edu + 0.74*parent.edu + 0.18*fam.income - 2.23*minority - 1.4*dist.school.hour + classroom_score +  rnorm(N, 0 ,1)
  
  # observed outcome based on treatment 
  Y_stud <- ifelse(Z_stud == 1, Y1, Y0)

  # create dataset
  # output does not include a confounder, distance to school in hours, which violates ignorability as this informs both
  # pretest scores (and therefore treatment assignment) and outcomes
  classroom_dat <- data.frame(yearstea = yearstea, teach.edu = as.factor(teach.edu), avgtest = avgtest,  
                            minority = as.factor(minority), parent.edu = as.factor(parent.edu), fam.income = fam.income,  
                            freelunch = as.factor(freelunch), gender = as.factor(gender), pretest = pretest,
                            classid = rep(1:classrooms, each = students), studentid  = 1:N, 
                            Z_stud = Z_stud, Y0 = Y0, Y1 = Y1, Y_stud = Y_stud)
  
  return(classroom_dat)
}
```


```{r}

ig_dat <- ig_dat_function(40, 25)

SATE_ig <- mean(ig_dat$Y1) - mean(ig_dat$Y0)

model_ig <- ig_dat %>% select(Y_stud, Z_stud, yearstea, teach.edu, avgtest, minority, parent.edu, fam.income, 
                              freelunch, gender, pretest, classid)

#Ignorability Violation - Linear Regression
lr.ig <- lm(Y_stud ~., data = model_ig[,-12])
summary(lr.ig)

#Ignorability Violation - Linear Regression Model Bias
(lr.ig.bias <- lr.ig$coefficients[2] - SATE_ig)

#Ignorability Violation w/ Fixed Effects
fixed.ig <- lfe::felm(model_ig$Y_stud ~ model_ig$Z_stud + model_ig$minority + model_ig$parent.edu + 
                        model_ig$fam.income + model_ig$freelunch + model_ig$gender + model_ig$pretest |model_ig$classid)
summary(fixed.ig)$coefficients[1]

fixed.ig.factor <- lm(model_ig$Y_stud ~ model_ig$Z_stud + model_ig$minority + model_ig$parent.edu + 
                        model_ig$fam.income + model_ig$freelunch + model_ig$gender + model_ig$pretest + factor(model_ig$classid))
summary(fixed.ig.factor)$coefficients[2]

#Ignorability Violation - Fixed Effects Model Bias
(fe.ig.bias <- fixed.base$coefficients[1] - SATE_ig)

#Ignorability Violation w/ Random Effects
random.ig <- lmerTest::lmer(Y_stud ~ Z_stud + minority + parent.edu + fam.income + freelunch + gender + pretest + (1 | classid), data = model_ig)
summary(random.ig)

#Base - Random Effects Model Bias
(re.ig.bias <- summary(random.ig)$coefficients[2,1] - SATE_ig)
```

Section IV: Treatment Assignment at the Group Level

*Make sure to interpret bias & treatment effect coefficients at the GROUP LEVEL - estimand has changed; treatment effect of the treated group*

```{r}
#Treatment Effect of the Treated @ Group Level
model_class <- classroom_dat %>% select(Y_class, Z_class, yearstea, teach.edu, avgtest, minority, parent.edu,
                                        fam.income, freelunch, dist.school.hour, gender, pretest, classid)

#Group Level Treatment Effect Linear Regression
lr.gl <- lm(Y_class ~., data = model_class[,-13])
summary(lr.gl)

#Group Level Treatment Effect - Linear Regression Model Bias
(lr.gl.bias <- lr.gl$coefficients[2] - SATE)

#Group Level Treatment Effect w/ Fixed Effects
fixed.gl <- lfe::felm(model_class$Y_class ~ model_class$Z_class + model_class$minority + model_class$parent.edu +
                        model_class$fam.income + model_class$freelunch + model_class$dist.school.hour +
                        model_class$gender + model_class$pretest | model_class$classid)
summary(fixed.gl)

### 
fixed.gl.factor <- lm(model_class$Y_class ~ model_class$Z_class + model_class$minority + model_class$parent.edu +
                        model_class$fam.income + model_class$freelunch + model_class$dist.school.hour +
                        model_class$gender + model_class$pretest + factor(model_class$classid) +
                        model_class$yearstea + model_class$avgtest + factor(model_class$teach.edu))
summary(fixed.gl.factor)$coefficients[2]


#Group Level Treatment Effect - Fixed Effects Model Bias
## Z_class does not return coeffient - I think this makes sense since we're running the regression at the class level?
# (fe.gl.bias <- fixed.gl$coefficients[1] - SATE)

#Group Level Treatment Effect w/ ****Random Effects***
random.gl <- lmerTest::lmer(Y_class ~ Z_class + minority + parent.edu + fam.income + freelunch + dist.school.hour +
                              gender + pretest + yearstea + avgtest + factor(teach.edu) + (1 | classid), data = model_class)
summary(random.gl)

#Group Level Treatment Effect - Random Effects Model Bias
(re.gl.bias <- summary(random.gl)$coefficients[2,1] - SATE)

#Group Level Treatment Effect w/ Random Effects correlate with treatment
random.gl.corre <- lmerTest::lmer(Y_class ~ Z_class + minority + parent.edu + fam.income + freelunch + dist.school.hour +
                              gender + pretest + yearstea + avgtest + factor(teach.edu) + (1 + Z_class| classid), data = model_class)
summary(random.gl.corre)$coefficients[2,1]

#Group Level Treatment Effect - Random Effects Model Bias
(summary(random.gl.corre)$coefficients[2,1] - SATE)

```

Comparison Tables

```{r, fig.height = 2, fig.width = 7}

bias_compare <- data.frame("Bias Comparison" = c("Linear Regression", "Fixed Effects", "Random Effects"), 
                           "Base Case" = round(c(lr.base.bias, fe.base.bias, re.base.bias),2), 
                           "RE Violation" = round(c(lr.re.bias, fe.re.bias, re.re.bias),2), 
                           "Ig. Violation" = round(c(lr.ig.bias, fe.ig.bias, re.ig.bias),2), 
                           "Group Treatment" = c(round(lr.gl.bias,2), "N/A", round(re.gl.bias,2)))

grid.arrange(tableGrob(bias_compare, theme=ttheme_default()), nrow = 1)
```

